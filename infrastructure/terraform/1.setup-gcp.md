# Setup GCP

This project use `GCP` for Infrastructure<br>
Have to create a Service Account for manage permission in this project.

### Account Create Project

- Use your `Owner Account (GCP Account)` because Owner Account no need permission to grant, so you can use your GCP Owner Account without setup permission below
- Or use your `Service Account` for security example
  - Developer in your team need Service Account to create some serviece
  - You want to manage project by Service Account

This project creating with `Service Account`

### 1. Enable APIs

Open GCP > API & Services > Library > Search APIs by name and Enable it

- `Compute Engine API`
- `Cloud Identity-Aware Proxy API`
- `Cloud Resource Manager API`
- `Identity and Access Management (IAM) API`
- `Cloud Logging API`
- `Artifact Registry API`

Make sure API are enabled!

### 2. Create Project and Service Account

- Create new project in `GCP`
- In `IAM` create Service Account (IAM is one of GCP services)

  Fill your project id and members google account in `infrastructure/terraform/dev/terraform.tfvars`

  ```bash
  # project_id = "ci-cd-gcp"
  project_id = "your-project-id" # gcp project id

  region = "define-region"   # region of vm host
  zone   = "define-zone"     # zone of region
  image  = "define-vm-image" # define vm image

  members = [
    "example1@gmail.com",
    "example2@gmail.com",
    "example3@gmail.com"
  ]
  ```

### 3. Grant Permissions

Open GCP Cloud Shell

- Setup Environment Variable

  ```bash
  export PROJECT_ID="your-gcp-project-id"
  export SERVICE_ACCOUNT="your-gcp-service-account"
  ```

  Grant Permission

  ```bash
  # 1. Compute Admin - Manage VM, Firewall, Load Balancer, ...
  gcloud projects add-iam-policy-binding $PROJECT_ID \
    --member="serviceAccount:$SERVICE_ACCOUNT" \
    --role="roles/compute.admin"

  # 2. Service Account Admin - Create and Manage Service Account
  gcloud projects add-iam-policy-binding $PROJECT_ID \
    --member="serviceAccount:$SERVICE_ACCOUNT" \
    --role="roles/iam.serviceAccountAdmin"

  # 3. Service Account User - for Impersonate
  gcloud projects add-iam-policy-binding $PROJECT_ID \
    --member="serviceAccount:$SERVICE_ACCOUNT" \
    --role="roles/iam.serviceAccountUser"

  # 4. Project IAM Admin - Grant IAM for Users/SAs
  gcloud projects add-iam-policy-binding $PROJECT_ID \
    --member="serviceAccount:$SERVICE_ACCOUNT" \
    --role="roles/resourcemanager.projectIamAdmin"

  # 5. Storage Admin - Manage GCS Bucket, terraform initial
  gcloud projects add-iam-policy-binding $PROJECT_ID \
    --member="serviceAccount:$SERVICE_ACCOUNT" \
    --role="roles/storage.admin"

  # 6. IAP Admin - Manage IAP resources and IAM policy
  gcloud projects add-iam-policy-binding $PROJECT_ID \
    --member="serviceAccount:$SERVICE_ACCOUNT" \
    --role="roles/iap.admin"
  ```

### 4. Create GCS Bucket

Terraform need object storage to store `Terraform State File`, use `GCS Bucket` to store it

- Create Bucket and fill `your-bucket-name`
- Bucket must be Unique Name

  ```bash
  # Create Bucket
  gsutil mb -p $PROJECT_ID -c STANDARD -l asia-southeast1 gs://bucket-name

  # Enable versioning
  gsutil versioning set on gs://your-bucket-name

  # Checking is bucket created
  gsutil ls -b gs://your-bucket-name
  ```

  Example

  ```bash
  # Create Bucket
  gsutil mb -p adept-bridge-466219-v7 -c STANDARD -l asia-southeast1 gs://ci-cd-gcp-tf-state

  # Enable versioning
  gsutil versioning set on gs://ci-cd-gcp-tf-state

  # Checking is bucket created
  gsutil ls -b gs://ci-cd-gcp-tf-state
  ```

  Change `Bucket` name in `infrastructure/terraform/dev/backend.tf` to your new `Bucket` name

  `backend.tf`

  ```bash
  terraform {
    backend "gcs" {
      bucket = "your-bucket-name"
      prefix = "dev/state"
    }
  }
  ```

  Don't forget it!
