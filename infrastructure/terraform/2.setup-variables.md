# Setup HashiCorp Vault

Use `HashiCorp Vault` to store secret -> Service Account Credential, Oauth2.0 Credential

### 1. Start Server

- For `Dev` Environment

  ```bash
  vault server -dev
  ```

  Output Example

  ```text
  You may need to set the following environment variables:
    PowerShell:
    $env:VAULT_ADDR="http://127.0.0.1:8200"
    cmd.exe:
    set VAULT_ADDR=http://127.0.0.1:8200

    The unseal key and root token are displayed below in case you want to
    seal/unseal the Vault or re-authenticate.

    Unseal Key: your-unseal-key
    Root Token: hvs.your-root-token

    Development mode should NOT be used in production installations!
  ```

### 2. Setup Environment Variable

<b>Open new shell</b>

- Create `.env` file in `infrastructure/terraform/dev` and copy it below

  `.env`

  ```bash
  # Vault lister server
  VAULT_ADDR=http://127.0.0.1:8200

  # Terraform Vault authenticate
  TF_VAR_vault_address=http://127.0.0.1:8200
  TF_VAR_vault_token=your-root-token

  # Terraform GCP Authenticate
  # Go IAM & Admin > Service Account > Select your Service Account > Keys > Create New Key > Download Key json file
  GOOGLE_APPLICATION_CREDENTIALS=your-service-account-credential-file-name.json
  ```

  Create Environment Variable

  ```bash
  set -a # tell shell, after execute this let create any variable
  source .env # create variable in .env file
  set +a # tell shell, after execute this not create any variable
  ```

  Check Variable is Created

  ```bash
  # list environment variables
  env | grep -E "VAULT*|TF_VAR*|GOOGLE*"
  ```

### 3. Put Secret into Vault Server

Use secret engine `kv-v2` in Vault to store secret

Enable `kv-v2` engine in Vault Server and Create Mount Path `ci-cd-gcp`<br>
Open new terminal

```bash
vault secrets enable -path=ci-cd-gcp kv-v2
```

Put Credentials to `ci-cd-gcp` mount path

- `gcp-sa` store Service Account Credential
- `iap-creds` store IAP Credential

  ```bash
  # Service Account Secret
  # Same Account with .env define
  vault kv put ci-cd-gcp/dev/gcp-sa key=@your-service-account-credential.json

  # IAP Secret
  # Go Credentials > Create credentials > OAuth client ID > Application Type: Web application > Fill Authorized redirect URLs "https://iap.googleapis.com/oauth2/v2/authorize"
  vault kv put ci-cd-gcp/dev/iap-creds client_id="xxx" client_secret="xxx"
  ```

Checking Credential is put already

```bash
# List all secret engines
vault secrets list

# List all secret in path
vault kv list ci-cd-gcp/dev

# get secret
vault kv get ci-cd-gcp/dev/gcp-sa
vault kv get ci-cd-gcp/dev/iap-creds
```

### GCP Credentials

#### Why Setup Environment Variable to store path of GCP Service Account Credentials?

Before running `terraform` cli, `terraform` cannot find `service-account-key` in `.tfvars` or `vault` server, because `google` provider need credentials to authenticate with `terraform` before running such as `plan, apply, destroy, ...` so setup path to your GCP Service Account Credentials first before running `terraform`!
